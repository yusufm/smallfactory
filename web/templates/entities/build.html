{% extends "base.html" %}

{% block title %}Build {{ entity.sfid }} - smallFactory{% endblock %}

{% block content %}
<div class="content-container">
  <div class="mb-8">
    <nav class="flex" aria-label="Breadcrumb">
      <ol class="flex items-center space-x-4">
        <li>
          <a href="{{ url_for('entities_list') }}" class="text-gray-400 hover:text-gray-500">
            <i class="fas fa-id-card mr-1"></i>Entities
          </a>
        </li>
        <li>
          <div class="flex items-center">
            <i class="fas fa-chevron-right text-gray-400 mr-4"></i>
            <a href="{{ url_for('entities_view', sfid=entity.sfid) }}" class="text-gray-400 hover:text-gray-500">{{ entity.sfid }}</a>
          </div>
        </li>
        <li>
          <div class="flex items-center">
            <i class="fas fa-chevron-right text-gray-400 mr-4"></i>
            <span class="text-gray-900 font-medium">Build</span>
          </div>
        </li>
      </ol>
    </nav>

    <div class="flex items-start justify-between mt-2">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">Build {{ entity.get('name', entity.sfid) }}</h1>
        <p class="mt-2 text-gray-600 font-mono">SFID: {{ entity.sfid }}{% if released_rev %} • Released Rev: <span class="font-semibold">{{ released_rev }}</span>{% endif %}</p>
      </div>
      <div class="flex items-center gap-2">
        <a href="{{ url_for('entities_view', sfid=entity.sfid) }}" class="px-4 py-2 border border-gray-300 rounded-md text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
          <i class="fas fa-arrow-left mr-2"></i>Back to Entity
        </a>
      </div>
    </div>
  </div>

  {% if not is_product %}
  <div class="bg-yellow-50 border border-yellow-200 text-yellow-800 px-4 py-3 rounded">
    Build is available only for product entities (SFID starts with <code>p_</code>).
  </div>
  {% else %}

  <div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
    <div class="lg:col-span-2">
      <div class="bg-white rounded-lg shadow-sm border border-gray-200">
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
          <h2 class="text-lg font-semibold text-gray-900"><i class="fas fa-industry mr-2"></i>Create Build Record</h2>
        </div>
        <div class="px-6 py-5">
          {% if not can_build %}
          <div class="mb-4 bg-yellow-50 border border-yellow-200 text-yellow-800 px-4 py-3 rounded flex items-start justify-between gap-3">
            <div>
              <i class="fas fa-triangle-exclamation mr-2"></i>No revisions exist for this part.
              <p class="mt-1 text-sm">Open the part page to create a revision, then return here to build.</p>
            </div>
            <div>
              <a href="{{ url_for('entities_view', sfid=entity.sfid) }}" class="px-3 py-1.5 rounded bg-blue-600 text-white hover:bg-blue-700">
                <i class="fas fa-arrow-left mr-2"></i>Go to Part Page
              </a>
            </div>
          </div>
          {% endif %}
          <form id="build-get-form" class="space-y-4">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div>
                <label for="l_sfid" class="block text-sm font-medium text-gray-700">Location (optional)</label>
                <input id="l_sfid" name="l_sfid" type="text" value="{{ l_sfid or '' }}" placeholder="leave blank for default" class="mt-1 w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div>
                <label for="notes" class="block text-sm font-medium text-gray-700">Notes (optional)</label>
                <input id="notes" name="notes" type="text" value="{{ notes or '' }}" placeholder="e.g. operator, context, etc." class="mt-1 w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div class="sm:col-span-2">
                <label for="rev" class="block text-sm font-medium text-gray-700">Revision</label>
                <select id="rev" name="rev" class="mt-1 w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500" {% if not can_build %}disabled{% endif %}>
                  {% if released_rev %}
                  <option value="released" {% if (rev_selected or 'released') == 'released' %}selected{% endif %}>Released ({{ released_rev }})</option>
                  {% endif %}
                  {% if revisions and revisions|length > 0 %}
                  <optgroup label="All revisions">
                    {% for m in revisions %}
                    {% set rid = m.get('id') %}
                    {% set st = m.get('status') %}
                    <option value="{{ rid }}" {% if rev_selected == rid %}selected{% endif %}>Rev {{ rid }}{% if st %} ({{ st }}){% endif %}</option>
                    {% endfor %}
                  </optgroup>
                  {% endif %}
                </select>
                <p class="mt-1 text-xs text-gray-500">Default is the currently released revision.</p>
              </div>
            </div>
            <div class="flex gap-2 pt-2">
              {% if can_build %}
              <button type="button" class="px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700" onclick="openBuildConfirmModal()">
                <i class="fas fa-plus mr-2"></i>Create Build Record
              </button>
              {% else %}
              <button type="button" class="px-4 py-2 rounded bg-gray-300 text-gray-600 cursor-not-allowed" disabled>
                <i class="fas fa-ban mr-2"></i>Build disabled (no revisions)
              </button>
              <a href="{{ url_for('entities_view', sfid=entity.sfid) }}" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">
                <i class="fas fa-arrow-left mr-2"></i>Go to Part Page
              </a>
              {% endif %}
            </div>
          </form>

          <!-- Hidden POST form used by modal confirm -->
          <form id="build-post-form" method="POST" action="{{ url_for('entities_build', sfid=entity.sfid) }}" class="hidden">
            <input type="hidden" name="l_sfid" value="{{ l_sfid or '' }}">
            <input type="hidden" name="notes" value="{{ notes or '' }}">
            <input type="hidden" name="rev" value="{{ rev_selected or (released_rev and 'released') or '' }}">
          </form>
        </div>
      </div>

      <!-- No preview/backflush in simplified flow -->
    </div>

    <div class="lg:col-span-1">
      <div class="bg-white rounded-lg shadow-sm border border-gray-200">
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
          <h2 class="text-lg font-semibold text-gray-900">Notes</h2>
        </div>
        <div class="px-6 py-5 text-sm text-gray-700 space-y-2">
          <p>Create a build record entity with prefix <code>b_</code> so you can attach photos/files for this specific unit.</p>
          <p>Location is optional. You can add files after creating the record.</p>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<!-- Build Confirmation Modal -->
<div id="build-confirm-modal" class="fixed inset-0 bg-black/30 z-50 hidden" aria-modal="true" role="dialog">
  <div class="min-h-full flex items-center justify-center p-4" onclick="if(event.target===this) closeBuildConfirmModal();">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl" onclick="event.stopPropagation();">
      <div class="px-5 py-3 border-b border-gray-200 flex items-center justify-between">
        <h3 class="text-lg font-semibold text-gray-900"><i class="fas fa-industry mr-2"></i>Confirm Build Record</h3>
        <button type="button" class="text-gray-500 hover:text-gray-700" onclick="closeBuildConfirmModal()">×</button>
      </div>
      <div class="px-5 py-4 text-sm text-gray-800 space-y-3">
        <p>You are about to create a build record for <span class="font-mono">{{ entity.sfid }}</span>.</p>
        <div class="text-gray-700 space-y-1">
          <div><span class="text-gray-500">Location:</span> <span id="summary-l_sfid" class="font-mono">{{ l_sfid or 'default' }}</span></div>
          <div><span class="text-gray-500">Notes:</span> <span id="summary-notes">{{ notes or '-' }}</span></div>
          <div><span class="text-gray-500">Revision:</span> <span id="summary-rev" class="font-mono">{{ (rev_selected == 'released' and released_rev) or rev_selected or (released_rev or '-') }}</span></div>
        </div>
      </div>
      <div class="px-5 py-3 border-t border-gray-200 flex justify-end gap-2">
        <button type="button" class="px-3 py-1.5 rounded border border-gray-300 bg-white text-gray-700 hover:bg-gray-50" onclick="closeBuildConfirmModal()">Cancel</button>
        <button type="button" class="px-3 py-1.5 rounded bg-green-600 text-white hover:bg-green-700" onclick="submitBuildPostForm()">Confirm Build</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const modal = document.getElementById('build-confirm-modal');
  function openBuildConfirmModal() {
    // Sync hidden POST form and modal summary with current form values
    try {
      const getForm = document.getElementById('build-get-form');
      const postForm = document.getElementById('build-post-form');
      const l = (getForm.l_sfid.value || '').trim();
      const n = (getForm.notes.value || '').trim();
      const r = (getForm.rev?.value || '').trim();
      postForm.querySelector('input[name="l_sfid"]').value = l;
      postForm.querySelector('input[name="notes"]').value = n;
      if (postForm.querySelector('input[name="rev"]')) {
        postForm.querySelector('input[name="rev"]').value = r;
      }
      const sumL = document.getElementById('summary-l_sfid');
      const sumN = document.getElementById('summary-notes');
      const sumR = document.getElementById('summary-rev');
      if (sumL) sumL.textContent = l || 'default';
      if (sumN) sumN.textContent = n || '-';
      if (sumR) {
        // If 'released' is chosen, show the actual released label from a data attr on select
        const sel = getForm.rev;
        let disp = r;
        if (sel && r === 'released') {
          const lbl = sel.options[sel.selectedIndex]?.textContent || '';
          // Expect text like 'Released (X)' - extract inside parens if present
          const m = lbl.match(/\(([^)]+)\)/);
          disp = (m && m[1]) ? m[1] : 'released';
        }
        sumR.textContent = disp || '-';
      }
    } catch (e) {}
    modal.classList.remove('hidden');
  }
  function closeBuildConfirmModal() {
    modal.classList.add('hidden');
  }
  function submitBuildPostForm() {
    document.getElementById('build-post-form').submit();
  }
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeBuildConfirmModal(); });
</script>
{% endblock %}
