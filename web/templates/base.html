<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}smallFactory{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="icon" href="{{ url_for('static', filename='img/favicon.svg') }}" type="image/svg+xml">
    <style>
        .sidebar-transition {
            transition: transform 0.3s ease-in-out;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        .content-container {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.9);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="glass-effect border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="{{ url_for('index') }}" class="flex-shrink-0 flex items-center focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <i class="fas fa-cube text-blue-600 text-2xl mr-3"></i>
                        <span class="text-xl font-bold text-gray-900">smallFactory</span>
                    </a>
                    <div class="hidden md:ml-6 md:flex md:space-x-8">
                        <a href="{{ url_for('inventory_list') }}" class="{% if request.endpoint and request.endpoint.startswith('inventory') %}border-blue-500 text-gray-900{% else %}border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700{% endif %} inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-colors">
                            <i class="fas fa-boxes mr-2"></i>Inventory
                        </a>
                        <a href="{{ url_for('entities_list', type='p') }}" class="{% set sf = (request.view_args.get('sfid') if request.view_args else '') %}{% if (request.endpoint and request.endpoint.startswith('entities')) and ((request.args.get('type') == 'p') or (sf and sf.startswith('p_'))) %}border-blue-500 text-gray-900{% else %}border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700{% endif %} inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-colors">
                            <i class="fas fa-cubes mr-2"></i>Parts
                        </a>
                        <a href="{{ url_for('entities_list', type='b') }}" class="{% set sf = (request.view_args.get('sfid') if request.view_args else '') %}{% if (request.endpoint and request.endpoint.startswith('entities')) and ((request.args.get('type') == 'b') or (sf and sf.startswith('b_'))) %}border-blue-500 text-gray-900{% else %}border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700{% endif %} inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-colors">
                            <i class="fas fa-industry mr-2"></i>Builds
                        </a>
                        <a href="{{ url_for('vision_page') }}" class="{% if request.endpoint and request.endpoint.startswith('vision') %}border-blue-500 text-gray-900{% else %}border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700{% endif %} inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-colors">
                            <i class="fas fa-wand-magic-sparkles mr-2"></i>Vision
                        </a>
                        <a href="{{ url_for('stickers_index') }}" class="{% if request.endpoint and request.endpoint.startswith('stickers') %}border-blue-500 text-gray-900{% else %}border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700{% endif %} inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium transition-colors">
                            <i class="fas fa-qrcode mr-2"></i>Stickers
                        </a>
                    </div>
                </div>
                <div class="flex items-center">
                    {# SaaS desktop partial (if provided by SF_EXTRA_TEMPLATES) #}
                    {% include 'saas/nav.html' ignore missing %}
                    <div class="relative hidden md:block">
                        <button id="sf-ann-btn" type="button" class="relative inline-flex items-center justify-center p-2 rounded-md text-gray-500 hover:text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" aria-label="Messages">
                            <i class="fas fa-message"></i>
                            <span id="sf-ann-dot" class="absolute -top-0.5 -right-0.5 hidden h-2.5 w-2.5 rounded-full bg-red-600"></span>
                        </button>
                        <div id="sf-ann-dd" class="hidden absolute right-0 mt-2 w-96 max-w-[90vw] bg-white border border-gray-200 rounded-lg shadow-lg z-50">
                            <div id="sf-ann-empty" class="hidden px-4 py-3 text-sm text-gray-600">No messages.</div>
                            <div id="sf-ann-body" class="max-h-96 overflow-auto"></div>
                        </div>
                    </div>
                    <button id="mobile-menu-button" class="md:hidden inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
            </div>
        </div>
        <!-- Mobile menu -->
        <div id="mobile-menu" class="md:hidden hidden">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3 bg-white border-t border-gray-200">
                <a href="{{ url_for('inventory_list') }}" class="{% if request.endpoint and request.endpoint.startswith('inventory') %}bg-blue-50 border-blue-500 text-blue-700{% else %}border-transparent text-gray-600 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-800{% endif %} block pl-3 pr-4 py-2 border-l-4 text-base font-medium">
                    <i class="fas fa-boxes mr-2"></i>Inventory
                </a>
                
                <a href="{{ url_for('entities_list', type='p') }}" class="{% set sf = (request.view_args.get('sfid') if request.view_args else '') %}{% if (request.endpoint and request.endpoint.startswith('entities')) and ((request.args.get('type') == 'p') or (sf and sf.startswith('p_'))) %}bg-blue-50 border-blue-500 text-blue-700{% else %}border-transparent text-gray-600 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-800{% endif %} block pl-3 pr-4 py-2 border-l-4 text-base font-medium">
                    <i class="fas fa-cubes mr-2"></i>Parts
                </a>
                <a href="{{ url_for('entities_list', type='b') }}" class="{% set sf = (request.view_args.get('sfid') if request.view_args else '') %}{% if (request.endpoint and request.endpoint.startswith('entities')) and ((request.args.get('type') == 'b') or (sf and sf.startswith('b_'))) %}bg-blue-50 border-blue-500 text-blue-700{% else %}border-transparent text-gray-600 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-800{% endif %} block pl-3 pr-4 py-2 border-l-4 text-base font-medium">
                    <i class="fas fa-industry mr-2"></i>Builds
                </a>
                <a href="{{ url_for('vision_page') }}" class="{% if request.endpoint and request.endpoint.startswith('vision') %}bg-blue-50 border-blue-500 text-blue-700{% else %}border-transparent text-gray-600 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-800{% endif %} block pl-3 pr-4 py-2 border-l-4 text-base font-medium">
                    <i class="fas fa-wand-magic-sparkles mr-2"></i>Vision
                </a>
                <a href="{{ url_for('stickers_index') }}" class="{% if request.endpoint and request.endpoint.startswith('stickers') %}bg-blue-50 border-blue-500 text-blue-700{% else %}border-transparent text-gray-600 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-800{% endif %} block pl-3 pr-4 py-2 border-l-4 text-base font-medium">
                    <i class="fas fa-qrcode mr-2"></i>Stickers
                </a>
                <a href="{{ url_for('announcements') }}" class="{% if request.endpoint == 'announcements' %}bg-blue-50 border-blue-500 text-blue-700{% else %}border-transparent text-gray-600 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-800{% endif %} block pl-3 pr-4 py-2 border-l-4 text-base font-medium">
                    <i class="fas fa-message mr-2"></i>Messages
                </a>
                {# SaaS mobile partial (if provided by SF_EXTRA_TEMPLATES) #}
                {% include 'saas/mobile_nav.html' ignore missing %}
            </div>
        </div>
    </nav>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-4">
                {% for category, message in messages %}
                    <div class="flash-message fade-in mb-4 p-4 rounded-md {% if category == 'error' %}bg-red-50 border border-red-200 text-red-700{% elif category == 'success' %}bg-green-50 border border-green-200 text-green-700{% else %}bg-blue-50 border border-blue-200 text-blue-700{% endif %}">
                        <div class="flex items-center">
                            <i class="{% if category == 'error' %}fas fa-exclamation-triangle{% elif category == 'success' %}fas fa-check-circle{% else %}fas fa-info-circle{% endif %} mr-2"></i>
                            {{ message }}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 mt-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="text-center text-gray-500 text-sm">
                <p>smallFactory - Git-native PLM System</p>
                <p class="mt-1 text-xs text-gray-400">
                    {% set v = app_version or {} %}
                    {% if v.short %}
                        Version: <span class="font-mono">{{ v.short }}</span>
                        {% if v.branch %}<span class="ml-1">({{ v.branch }})</span>{% endif %}
                        {% if v.dirty %}<span class="ml-1 text-rose-500" title="Uncommitted changes">â€¢ dirty</span>{% endif %}
                        {% if v.date %}<span class="ml-2">{{ v.date }}</span>{% endif %}
                    {% else %}
                        Version: not a git checkout
                    {% endif %}
                </p>
            </div>
        </div>
    </footer>

    <script>
        // Mobile menu toggle
        document.getElementById('mobile-menu-button').addEventListener('click', function() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        });

        (function(){
            // This URL is defined in announcements.html as well. Modify there if you change this.
            const ANN_URL = 'https://raw.githubusercontent.com/yusufm/smallfactory/main/announcements.txt';
            const READ_HASH_KEY = 'sf_announcements_read_hash';
            const CACHE_KEY = 'sf_announcements_cache';
            const CACHE_TS_KEY = 'sf_announcements_cache_ts';
            const ONE_HOUR = 60 * 60 * 1000; // Change to 60 * 1000 for 1-minute testing

            function simpleHash(str){
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return hash.toString();
            }
            function getLastReadHash(){
                try {
                    return localStorage.getItem(READ_HASH_KEY) || '';
                } catch(e) {
                    return '';
                }
            }
            function markAsRead(hash){
                try {
                    localStorage.setItem(READ_HASH_KEY, hash);
                } catch(e) {}
            }
            function getCachedData(){
                try {
                    const ts = localStorage.getItem(CACHE_TS_KEY);
                    if (!ts) return null;
                    const age = Date.now() - parseInt(ts, 10);
                    if (age > ONE_HOUR) return null;
                    const cached = localStorage.getItem(CACHE_KEY);
                    return cached ? JSON.parse(cached) : null;
                } catch(e) {
                    return null;
                }
            }
            function setCachedData(data){
                try {
                    localStorage.setItem(CACHE_KEY, JSON.stringify(data));
                    localStorage.setItem(CACHE_TS_KEY, String(Date.now()));
                } catch(e) {}
            }
            function parseMarkdown(text){
                if (!text) return '';
                return text
                    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer" class="text-blue-700 hover:text-blue-900 underline">$1</a>')
                    .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*([^*]+)\*/g, '<em>$1</em>');
            }
            async function fetchMessages(){
                try {
                    const res = await fetch(ANN_URL, { cache: 'no-store' });
                    if (!res.ok) return { messages: [], hash: '' };
                    const text = await res.text();
                    const lines = text.split('\n').map(l => l.trim()).filter(l => l);
                    const hash = simpleHash(text);
                    return { messages: lines, hash };
                } catch(e) {
                    return { messages: [], hash: '' };
                }
            }

            const btn = document.getElementById('sf-ann-btn');
            const dot = document.getElementById('sf-ann-dot');

            function _el(id){ try { return document.getElementById(id); } catch(e) { return null; } }
            function isDropdownOpen(){ const d = _el('sf-ann-dd'); return d && !d.classList.contains('hidden'); }
            function openDropdown(){ const d = _el('sf-ann-dd'); if (d) d.classList.remove('hidden'); }
            function closeDropdown(){ const d = _el('sf-ann-dd'); if (d) d.classList.add('hidden'); }
            function toggleDropdown(){ isDropdownOpen() ? closeDropdown() : openDropdown(); }

            function setDotVisible(visible){
                if (!btn || !dot) return;
                if (visible) dot.classList.remove('hidden');
                else dot.classList.add('hidden');
            }

            function renderMessages(msgs){
                const body = _el('sf-ann-body');
                const empty = _el('sf-ann-empty');
                if (!body || !empty) return;
                body.innerHTML = '';
                if (!msgs || !msgs.length){
                    empty.classList.remove('hidden');
                    return;
                }
                empty.classList.add('hidden');

                msgs.forEach((line) => {
                    const item = document.createElement('div');
                    item.className = 'px-4 py-3 border-b border-gray-100 text-sm text-gray-700';
                    item.innerHTML = parseMarkdown(line);
                    body.appendChild(item);
                });
            }

            let lastData = { messages: [], hash: '' };
            function updateDotAndRerender(){
                const lastRead = getLastReadHash();
                const hasUnread = lastData.hash && lastData.hash !== lastRead;
                setDotVisible(hasUnread);
                renderMessages(lastData.messages);
            }

            async function loadAnnouncements(){
                if (!btn) return;
                btn.classList.remove('hidden');
                
                const cached = getCachedData();
                if (cached) {
                    console.log('[announcements] using cached data');
                    lastData = cached;
                    updateDotAndRerender();
                    return;
                }
                
                console.log('[announcements] fetching fresh data');
                lastData = await fetchMessages();
                console.log('[announcements] fetched:', lastData);
                if (lastData.hash) {
                    setCachedData(lastData);
                }
                updateDotAndRerender();
            }

            if (btn){
                btn.addEventListener('click', function(){
                    toggleDropdown();
                    if (isDropdownOpen()) {
                        markAsRead(lastData.hash);
                        updateDotAndRerender();
                    }
                });
            }
            document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeDropdown(); });
            document.addEventListener('click', (e)=>{
                try {
                    if (!isDropdownOpen()) return;
                    const dd = _el('sf-ann-dd');
                    if (!dd) return;
                    if (btn && (btn === e.target || btn.contains(e.target))) return;
                    if (dd === e.target || dd.contains(e.target)) return;
                    closeDropdown();
                } catch(err) {}
            });
            document.addEventListener('DOMContentLoaded', function(){
                try { loadAnnouncements(); } catch(e) {}
            });
        })();

        // Auto-hide flash messages after 5 seconds (only actual flash messages)
        setTimeout(function() {
            const flashMessages = document.querySelectorAll('.flash-message.fade-in');
            flashMessages.forEach(function(msg) {
                msg.style.transition = 'opacity 0.5s ease-out';
                msg.style.opacity = '0';
                setTimeout(function() {
                    msg.remove();
                }, 500);
            });
        }, 5000);
        // Lightweight toast notifications
        // Usage: showToast('Message', { type: 'info' | 'success' | 'error', duration: 4000 })
        window.showToast = function(message, opts){
            try {
                const options = opts || {};
                const type = options.type || 'info';
                const duration = Number(options.duration || 4000);
                let container = document.getElementById('toast-container');
                if(!container){
                    container = document.createElement('div');
                    container.id = 'toast-container';
                    container.className = 'fixed bottom-4 right-4 z-50 space-y-2';
                    document.body.appendChild(container);
                }
                const base = 'max-w-sm w-80 pointer-events-auto px-4 py-3 rounded-lg shadow-lg ring-1 ring-black ring-opacity-5 transition transform duration-200 ease-out opacity-0 translate-y-2 flex items-start space-x-3';
                const styles = {
                    info: 'bg-white text-gray-800 border border-gray-200',
                    success: 'bg-green-50 text-green-800 border border-green-200',
                    error: 'bg-red-50 text-red-800 border border-red-200'
                };
                const toast = document.createElement('div');
                toast.setAttribute('role', 'status');
                toast.setAttribute('aria-live', 'polite');
                toast.className = base + ' ' + (styles[type] || styles.info);
                const iconSpan = document.createElement('span');
                iconSpan.className = 'mt-0.5';
                iconSpan.innerHTML = type === 'success' ? '<i class="fas fa-check-circle"></i>' : (type === 'error' ? '<i class="fas fa-exclamation-triangle"></i>' : '<i class="fas fa-info-circle"></i>');
                const msgDiv = document.createElement('div');
                msgDiv.className = 'text-sm';
                msgDiv.textContent = message || '';
                const closeBtn = document.createElement('button');
                closeBtn.type = 'button';
                closeBtn.className = 'ml-auto text-gray-400 hover:text-gray-600 focus:outline-none';
                closeBtn.innerHTML = '<span class="sr-only">Close</span><i class="fas fa-times"></i>';
                closeBtn.addEventListener('click', () => removeToast());
                toast.appendChild(iconSpan);
                toast.appendChild(msgDiv);
                toast.appendChild(closeBtn);
                container.appendChild(toast);
                // Animate in
                requestAnimationFrame(() => { toast.classList.remove('opacity-0', 'translate-y-2'); toast.classList.add('opacity-100', 'translate-y-0'); });
                let hideTimer = null;
                function removeToast(){
                    if(hideTimer) { clearTimeout(hideTimer); hideTimer = null; }
                    toast.classList.remove('opacity-100', 'translate-y-0');
                    toast.classList.add('opacity-0', 'translate-y-2');
                    setTimeout(() => { toast.remove(); }, 200);
                }
                hideTimer = setTimeout(removeToast, duration);
                return removeToast;
            } catch(e) { console.error(e); }
        };
    </script>
    
    {% block modals %}{% endblock %}
    <!-- Global toast container (populated by showToast) -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <!-- QR scanning support (QR-only) -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script>
        (function() {
            function isMobileish() {
                if (window.matchMedia && window.matchMedia('(pointer: coarse)').matches) return true;
                const ua = navigator.userAgent || '';
                return /Android|iPhone|iPad|iPod/i.test(ua);
            }

            function enhanceInputWithScanner(input) {
                if (!input || input.dataset.qrEnhanced === '1') return;
                input.dataset.qrEnhanced = '1';

                // Wrap input in a relative container to place the button
                const wrapper = document.createElement('div');
                wrapper.className = 'relative';
                input.parentNode.insertBefore(wrapper, input);
                wrapper.appendChild(input);

                // Ensure padding to avoid overlap
                input.classList.add('pr-10');

                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'absolute inset-y-0 right-0 px-3 text-gray-500 hover:text-gray-700 focus:outline-none';
                btn.title = 'Scan QR';
                btn.innerHTML = '<i class="fas fa-camera"></i>';
                wrapper.appendChild(btn);

                btn.addEventListener('click', function() {
                    openScannerFor(input);
                });
            }

            // Single hidden file input reused
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            // Hint to use rear camera on mobile
            fileInput.setAttribute('capture', 'environment');
            fileInput.className = 'hidden';
            document.addEventListener('DOMContentLoaded', function() { document.body.appendChild(fileInput); });

            function openScannerFor(targetInput) {
                if (typeof jsQR === 'undefined') {
                    showToast('QR scanner unavailable. Please check your connection and try again.', { type: 'error' });
                    return;
                }
                fileInput.value = '';
                fileInput.onchange = async function() {
                    const file = fileInput.files && fileInput.files[0];
                    if (!file) return;
                    try {
                        const dataUrl = await fileToDataURL(file);
                        const decoded = await decodeQrFromImage(dataUrl);
                        if (decoded) {
                            targetInput.value = decoded;
                            flashInput(targetInput);
                            // Trigger input event for any listeners
                            targetInput.dispatchEvent(new Event('input', { bubbles: true }));
                        } else {
                            showToast('No QR code found. Tip: keep the whole code in frame, ensure focus, and try moving slightly farther away.', { type: 'info' });
                        }
                    } catch (e) {
                        console.error('QR decode error:', e);
                        showToast('Failed to read image.', { type: 'error' });
                    }
                };
                fileInput.click();
            }

            function fileToDataURL(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            function decodeQrFromImage(dataUrl) {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = async () => {
                        // 1) Try native BarcodeDetector first (when available)
                        try {
                            if ('BarcodeDetector' in window) {
                                const detector = new BarcodeDetector({ formats: ['qr_code'] });
                                const results = await detector.detect(img);
                                if (results && results.length && results[0].rawValue) {
                                    resolve(results[0].rawValue);
                                    return;
                                }
                            }
                        } catch (e) {
                            // Ignore and fall back to jsQR
                        }

                        // 2) Fallback: try multiple sizes and rotations via jsQR
                        const maxDims = [1920, 1280, 1024, 800];
                        const rotations = [0, 90, 180, 270];
                        const options = { inversionAttempts: 'attemptBoth' };

                        const tryOnce = (maxDim, rotationDeg) => {
                            let w = img.naturalWidth || img.width;
                            let h = img.naturalHeight || img.height;
                            const scale = Math.min(1, maxDim / Math.max(w, h));
                            w = Math.round(w * scale);
                            h = Math.round(h * scale);

                            const rad = (rotationDeg * Math.PI) / 180;
                            const sin = Math.abs(Math.sin(rad));
                            const cos = Math.abs(Math.cos(rad));
                            const rw = Math.round(w * cos + h * sin);
                            const rh = Math.round(w * sin + h * cos);

                            const canvas = document.createElement('canvas');
                            canvas.width = rw;
                            canvas.height = rh;
                            const ctx = canvas.getContext('2d', { willReadFrequently: true });
                            if (!ctx) return null;
                            ctx.imageSmoothingEnabled = false;

                            ctx.translate(rw / 2, rh / 2);
                            ctx.rotate(rad);
                            ctx.drawImage(img, -w / 2, -h / 2, w, h);

                            const imageData = ctx.getImageData(0, 0, rw, rh);
                            const result = jsQR(imageData.data, imageData.width, imageData.height, options);
                            return result ? result.data : null;
                        };

                        for (let i = 0; i < maxDims.length; i++) {
                            for (let j = 0; j < rotations.length; j++) {
                                const decoded = tryOnce(maxDims[i], rotations[j]);
                                if (decoded) { resolve(decoded); return; }
                            }
                        }
                        resolve(null);
                    };
                    img.onerror = () => resolve(null);
                    img.src = dataUrl;
                });
            }

            function flashInput(el) {
                el.classList.add('ring-2', 'ring-green-400');
                setTimeout(() => el.classList.remove('ring-2', 'ring-green-400'), 1200);
            }

            // Initialize on DOM ready (mobile only)
            document.addEventListener('DOMContentLoaded', function() {
                if (!isMobileish()) return;
                const selector = [
                    'input[name="sfid"]',
                    'input#sfid',
                    'input[name="l_sfid"]',
                    'input#l_sfid',
                    'input[data-scan="sfid"]',
                    'input[data-scan="l_sfid"]'
                ].join(',');

                document.querySelectorAll(selector).forEach(enhanceInputWithScanner);

                // Also observe DOM mutations for dynamically added inputs
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((m) => {
                        m.addedNodes && m.addedNodes.forEach((node) => {
                            if (!(node instanceof HTMLElement)) return;
                            node.querySelectorAll && node.querySelectorAll(selector).forEach(enhanceInputWithScanner);
                            if (node.matches && node.matches(selector)) enhanceInputWithScanner(node);
                        });
                    });
                });
                observer.observe(document.body, { childList: true, subtree: true });
            });
        })();
    </script>
    <!-- Entity autocomplete (global) -->
    <script src="{{ url_for('static', filename='js/autocomplete.js') }}"></script>
    {% block scripts %}{% endblock %}
</body>
</html>
