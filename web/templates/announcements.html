{% extends "base.html" %}

{% block title %}Messages{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-8">
    <div class="mb-6">
        <h1 class="text-2xl font-bold text-gray-900">Messages</h1>
    </div>
    
    <div id="announcements-content" class="space-y-4">
        <div class="text-center py-8">
            <div class="inline-flex items-center justify-center w-8 h-8">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
            </div>
            <p class="text-gray-500 mt-2">Loading messages...</p>
        </div>
    </div>
</div>

<script>
(function(){
    // This URL is defined in base.html as well. Modify there if you change this.
    const ANN_URL = 'https://raw.githubusercontent.com/yusufm/smallfactory/main/announcements.txt';
    const READ_HASH_KEY = 'sf_announcements_read_hash';
    
    function simpleHash(str){
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash;
        }
        return hash.toString();
    }
    
    function markAsRead(hash){
        try {
            localStorage.setItem(READ_HASH_KEY, hash);
        } catch(e) {}
    }
    
    function toSafeExternalUrl(raw){
        try {
            const u = new URL(String(raw || ''), window.location.origin);
            if (u.protocol === 'http:' || u.protocol === 'https:') return u.href;
        } catch(e) {}
        return null;
    }

    function renderInlineMarkdown(text){
        const frag = document.createDocumentFragment();
        const src = String(text || '');
        const re = /\[([^\]]+)\]\(([^)]+)\)|\*\*([^*]+)\*\*|\*([^*]+)\*/g;
        let last = 0;
        let m;
        while ((m = re.exec(src)) !== null) {
            if (m.index > last) {
                frag.appendChild(document.createTextNode(src.slice(last, m.index)));
            }
            if (m[1] != null && m[2] != null) {
                const href = toSafeExternalUrl(m[2]);
                if (href) {
                    const a = document.createElement('a');
                    a.href = href;
                    a.target = '_blank';
                    a.rel = 'noopener noreferrer';
                    a.className = 'text-blue-700 hover:text-blue-900 underline';
                    a.textContent = m[1];
                    frag.appendChild(a);
                } else {
                    frag.appendChild(document.createTextNode(m[1]));
                }
            } else if (m[3] != null) {
                const strong = document.createElement('strong');
                strong.textContent = m[3];
                frag.appendChild(strong);
            } else if (m[4] != null) {
                const em = document.createElement('em');
                em.textContent = m[4];
                frag.appendChild(em);
            }
            last = re.lastIndex;
        }
        if (last < src.length) {
            frag.appendChild(document.createTextNode(src.slice(last)));
        }
        return frag;
    }
    
    async function loadAnnouncements(){
        try {
            const res = await fetch(ANN_URL, { cache: 'no-store' });
            if (!res.ok) {
                document.getElementById('announcements-content').innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-inbox text-gray-400 text-3xl mb-2"></i>
                        <p class="text-gray-500">No messages.</p>
                    </div>
                `;
                return;
            }
            
            const text = await res.text();
            const lines = text.split('\n').map(l => l.trim()).filter(l => l);
            const hash = simpleHash(text);
            
            // Mark as read since user is viewing the page
            markAsRead(hash);
            
            const content = document.getElementById('announcements-content');
            if (!lines || !lines.length) {
                content.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-inbox text-gray-400 text-3xl mb-2"></i>
                        <p class="text-gray-500">No messages</p>
                    </div>
                `;
                return;
            }
            
            content.innerHTML = '';
            lines.forEach((line) => {
                const outer = document.createElement('div');
                outer.className = 'bg-white border border-gray-200 rounded-lg p-4 shadow-sm';
                const inner = document.createElement('div');
                inner.className = 'text-gray-700 whitespace-pre-wrap';
                inner.appendChild(renderInlineMarkdown(line));
                outer.appendChild(inner);
                content.appendChild(outer);
            });
            
        } catch(e) {
            document.getElementById('announcements-content').innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-inbox text-gray-400 text-3xl mb-2"></i>
                    <p class="text-gray-500">No messages.</p>
                </div>
            `;
        }
    }
    
    // Load when page loads
    document.addEventListener('DOMContentLoaded', loadAnnouncements);
})();
</script>
{% endblock %}
